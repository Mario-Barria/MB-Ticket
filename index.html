
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MB Ticket - Escaneo y Registro</title>
</head>
<body>
  <!-- Este es un fragmento simplificado para mantener el foco en la función corregida -->
  <script>
    let socios = [];
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let entradasWeb = JSON.parse(localStorage.getItem('entradasWeb')) || [];
    let scanner;
    let selectedSocio = null;
    let ultimoEscaneo = null;

    function guardarRegistros() {
      localStorage.setItem('registros', JSON.stringify(registros));
    }

    function actualizarRegistros() {
      console.log("Registros actualizados");
    }

    function mostrarResultado(tipo, titulo, mensaje) {
      alert(`${titulo}: ${mensaje}`);
    }

    function playSuccessSound() {
      console.log("✅ Sonido éxito");
    }

    function playErrorSound() {
      console.log("❌ Sonido error");
    }

    function registrarManual() {
      registros = JSON.parse(localStorage.getItem('registros')) || [];

      if (!selectedSocio) {
        mostrarResultado('error', '❌ Error', 'Seleccione un socio de la lista');
        playErrorSound();
        return;
      }

      const hoy = new Date().toLocaleDateString();
      const registroExistente = registros.find(r => 
        r.dni === selectedSocio.dni && 
        new Date(r.fecha).toLocaleDateString() === hoy
      );

      if (registroExistente) {
        mostrarResultado('error', '❌ Ya ingresó hoy', `
            ${selectedSocio.nombre}<br>
            DNI: ${selectedSocio.dni}<br>
            Hora: ${registroExistente.fecha.split(',')[1].trim()}
        `);
        playErrorSound();
        return;
      }

      const registro = {
        dni: selectedSocio.dni,
        nombre: selectedSocio.nombre,
        fecha: new Date().toLocaleString(),
        tipo: "manual"
      };

      registros.push(registro);
      guardarRegistros();
      actualizarRegistros();

      mostrarResultado('success', '✅ Registrado', selectedSocio.nombre);
      playSuccessSound();

      if (typeof searchInput !== 'undefined') searchInput.value = '';
      if (typeof resultsList !== 'undefined') resultsList.style.display = 'none';
      selectedSocio = null;
      if (typeof manualRegisterBtn !== 'undefined') manualRegisterBtn.disabled = true;
    }
  </script>
</body>
</html>

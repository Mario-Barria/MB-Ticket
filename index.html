<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Ingreso por QR</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #preview { width: 100%; max-width: 400px; margin: auto; }
    #status { font-size: 24px; margin-top: 20px; }
    .ok { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Escaneo de QR - Control de Ingreso</h2>

  <input type="file" id="fileInput" accept=".csv">
  <p>Seleccioná tu archivo CSV con: Nombre, Apellido, DNI</p>

  <video id="preview"></video>
  <div id="status"></div>

  <button onclick="descargarIngresos()">Descargar lista de ingresos</button>

  <script src="https://unpkg.com/qr-scanner/qr-scanner.umd.min.js"></script>
  <script>
    let datosValidos = [];
    let ingresados = [];

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const lines = event.target.result.split('\n');
        datosValidos = lines.map(l => l.trim().split(',')).filter(l => l.length === 3);
        alert("Planilla cargada con " + datosValidos.length + " registros.");
      };
      reader.readAsText(file);
    });

    const video = document.getElementById('preview');
    const qrScanner = new QrScanner(video, result => verificarQR(result), {
      highlightScanRegion: true
    });
    qrScanner.start();

    function verificarQR(texto) {
  try {
    const dni = texto.trim(); // solo DNI escaneado
    const persona = datosValidos.find(d => d[2] === dni);

    if (!persona) {
      mostrarMensaje("❌ DNI no encontrado: " + dni, 'error');
      return;
    }

    const [nombre, apellido] = persona;

    if (ingresados.includes(dni)) {
      mostrarMensaje("❌ Ya ingresó: " + nombre + " " + apellido, 'error');
    } else {
      ingresados.push(dni);
      mostrarMensaje("✔️ Ingreso autorizado: " + nombre + " " + apellido, 'ok');
    }
  } catch (err) {
    mostrarMensaje("QR inválido", 'error');
  }
}

    function mostrarMensaje(mensaje, tipo) {
      const div = document.getElementById('status');
      div.innerText = mensaje;
      div.className = tipo;
    }

    function descargarIngresos() {
      let csv = "DNI\n" + ingresados.join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "ingresados.csv";
      a.click();
    }
  </script>
</body>
</html>
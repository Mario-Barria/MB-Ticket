<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validador de Socios MB-Ticket</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #2980b9;
      --success: #27ae60;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: var(--dark);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo {
      height: 80px;
      margin-bottom: 10px;
    }
    
    .file-upload {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #csvFile {
      display: none;
    }
    
    .file-upload label {
      background: var(--secondary);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: inline-block;
    }
    
    #csvStatus {
      margin-top: 10px;
      font-weight: bold;
    }
    
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #result {
      display: none;
      margin: 20px auto;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 500px;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    button {
      padding: 12px 20px;
      color: white !important;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px auto;
      font-weight: bold;
      width: 100%;
      max-width: 300px;
      display: block;
    }
    
    #exportBtn {
      background: var(--secondary);
    }
    
    #clearBtn {
      background: var(--danger);
    }
    
    #manualRegisterBtn {
      background: var(--success);
    }
    
    .search-box {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .search-results {
      position: relative;
    }
    
    #searchInput {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    #resultsList {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    
    .result-item:hover {
      background-color: #f5f5f5;
    }
    
    .result-item strong {
      color: var(--secondary);
    }
    
    #registros {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="gimnasia y esgrima.jpg" alt="Logo" class="logo">
      <h1>Validador de Socios</h1>
    </header>

    <div class="file-upload">
      <label for="csvFile">Seleccionar archivo CSV</label>
      <input type="file" id="csvFile" accept=".csv">
      <p id="csvStatus">Esperando archivo CSV...</p>
    </div>

    <div class="search-box">
      <h3>Búsqueda Manual</h3>
      <div class="search-results">
        <input type="text" id="searchInput" placeholder="Buscar por DNI o nombre (mínimo 3 caracteres)">
        <div id="resultsList"></div>
      </div>
      <button id="manualRegisterBtn" disabled>Registrar Manualmente</button>
    </div>

    <div id="reader"></div>
    
    <div id="result">
      <div id="icon" class="icon"></div>
      <div id="message"></div>
    </div>

    <div id="registros">
      <h3>Registros de Hoy</h3>
      <div id="registros-list">
        <p>No hay registros aún.</p>
      </div>
    </div>

    <button id="exportBtn">Generar Informe</button>
    <button id="clearBtn">Limpiar Registros</button>
  </div>

  <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
  <audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

  <script>
    // Variables globales
    let socios = [];
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let scanner;
    let selectedSocio = null;
    let ultimoQRLeido = null;
    let tiempoUltimoEscaneo = 0;

    // Elementos del DOM
    const csvFile = document.getElementById('csvFile');
    const csvStatus = document.getElementById('csvStatus');
    const searchInput = document.getElementById('searchInput');
    const resultsList = document.getElementById('resultsList');
    const manualRegisterBtn = document.getElementById('manualRegisterBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const registrosList = document.getElementById('registros-list');

    // Eventos
    csvFile.addEventListener('change', cargarCSV);
    searchInput.addEventListener('input', buscarSocios);
    manualRegisterBtn.addEventListener('click', registrarManual);
    exportBtn.addEventListener('click', exportarRegistros);
    clearBtn.addEventListener('click', limpiarRegistros);

    // Cargar CSV
    function cargarCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
          
          socios = lines.map(line => {
            const [nombre, apellido, dni] = line.split(';');
            return {
              nombre: `${nombre.trim()} ${apellido.trim()}`,
              dni: dni.trim()
            };
          });

          csvStatus.textContent = `✅ Archivo cargado: ${socios.length} socios`;
          csvStatus.style.color = "green";
          exportBtn.disabled = false;
          iniciarEscaneo();

        } catch (error) {
          csvStatus.textContent = "❌ Error: El archivo debe tener formato: Nombre;Apellido;DNI";
          csvStatus.style.color = "red";
          console.error("Error al procesar CSV:", error);
        }
      };
      
      reader.onerror = () => {
        csvStatus.textContent = "❌ Error al leer el archivo";
        csvStatus.style.color = "red";
      };
      
      reader.readAsText(file);
    }

    // Buscar socios (autocompletado)
    function buscarSocios() {
      const query = searchInput.value.trim().toLowerCase();
      resultsList.innerHTML = '';
      selectedSocio = null;
      manualRegisterBtn.disabled = true;

      if (query.length < 3) {
        resultsList.style.display = 'none';
        return;
      }

      const resultados = socios.filter(socio => 
        socio.dni.includes(query) || 
        socio.nombre.toLowerCase().includes(query)
      );

      if (resultados.length > 0) {
        resultsList.innerHTML = resultados.map(socio => `
          <div class="result-item" data-dni="${socio.dni}">
            <strong>${socio.nombre}</strong><br>
            DNI: ${socio.dni}
          </div>
        `).join('');
        resultsList.style.display = 'block';
        
        document.querySelectorAll('.result-item').forEach(item => {
          item.addEventListener('click', function() {
            const dni = this.getAttribute('data-dni');
            selectedSocio = socios.find(s => s.dni === dni);
            searchInput.value = selectedSocio.nombre;
            resultsList.style.display = 'none';
            manualRegisterBtn.disabled = false;
          });
        });
      } else {
        resultsList.innerHTML = '<div class="result-item">No se encontraron socios</div>';
        resultsList.style.display = 'block';
      }
    }

    // Iniciar escáner
    function iniciarEscaneo() {
      if (scanner) return;

      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          procesarQR(decodedText);
        },
        (error) => {
          console.log("Error:", error);
        }
      ).catch(err => {
        console.error("Error al iniciar:", err);
      });
    }

    // Procesar QR (VERSIÓN CORREGIDA)
    function procesarQR(qrContent) {
      const ahora = Date.now();
      if (qrContent === ultimoQRLeido && (ahora - tiempoUltimoEscaneo) < 3000) {
        return;
      }

      const dni = qrContent.split('=')[1] || qrContent;
      const socio = socios.find(s => s.dni === dni);
      
      if (!socio) {
        mostrarResultado('error', '❌ No registrado', `DNI: ${dni}`);
        document.getElementById('errorSound').play();
        return;
      }

      const registroExistente = registros.find(r => r.dni === dni && esHoy(r.fecha));
      if (registroExistente) {
        mostrarResultado('error', '❌ Ya ingresó hoy', `
          ${socio.nombre}<br>
          DNI: ${dni}<br>
          Hora anterior: ${registroExistente.fecha.split(',')[1].trim()}
        `);
        document.getElementById('errorSound').play();
        return;
      }

      const registro = {
        dni: dni,
        nombre: socio.nombre,
        fecha: new Date().toLocaleString()
      };
      
      registros.push(registro);
      localStorage.setItem('registros', JSON.stringify(registros));
      actualizarRegistros();
      
      mostrarResultado('success', '✅ Registrado', `
        ${socio.nombre}<br>
        DNI: ${dni}
      `);
      document.getElementById('successSound').play();

      ultimoQRLeido = qrContent;
      tiempoUltimoEscaneo = ahora;
    }

    // Registrar manualmente
    function registrarManual() {
      if (!selectedSocio) {
        mostrarResultado('error', '❌ Error', 'Seleccione un socio de la lista');
        document.getElementById('errorSound').play();
        return;
      }

      const registroExistente = registros.find(r => r.dni === selectedSocio.dni && esHoy(r.fecha));
      if (registroExistente) {
        mostrarResultado('error', '❌ Ya ingresó hoy', `
          ${selectedSocio.nombre}<br>
          DNI: ${selectedSocio.dni}<br>
          Hora anterior: ${registroExistente.fecha.split(',')[1].trim()}
        `);
        document.getElementById('errorSound').play();
        return;
      }

      const registro = {
        dni: selectedSocio.dni,
        nombre: selectedSocio.nombre,
        fecha: new Date().toLocaleString()
      };
      
      registros.push(registro);
      localStorage.setItem('registros', JSON.stringify(registros));
      actualizarRegistros();
      
      mostrarResultado('success', '✅ Registrado', selectedSocio.nombre);
      document.getElementById('successSound').play();
      
      // Limpiar búsqueda
      searchInput.value = '';
      resultsList.style.display = 'none';
      selectedSocio = null;
      manualRegisterBtn.disabled = true;
    }

    // Actualizar registros
    function actualizarRegistros() {
      const registrosHoy = registros.filter(r => esHoy(r.fecha));

      registrosList.innerHTML = registrosHoy.length > 0
        ? registrosHoy.map(r => `
            <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
              <strong>${r.fecha}</strong><br>
              ${r.nombre} (${r.dni})
            </div>
          `).join('')
        : '<p>No hay registros aún.</p>';
    }

    // Exportar registros
    function exportarRegistros() {
      const registrosHoy = registros.filter(r => esHoy(r.fecha));

      let csv = "Fecha,Nombre,DNI\n";
      registrosHoy.forEach(r => {
        csv += `"${r.fecha}","${r.nombre}","${r.dni}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `registros_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
      a.click();
    }

    // Limpiar registros
    function limpiarRegistros() {
      if (confirm('¿Borrar todos los registros de hoy?')) {
        registros = registros.filter(r => !esHoy(r.fecha));
        localStorage.setItem('registros', JSON.stringify(registros));
        actualizarRegistros();
      }
    }

    // Mostrar resultado
    function mostrarResultado(tipo, icono, mensaje) {
      const result = document.getElementById('result');
      result.innerHTML = `
        <div class="icon">${icono}</div>
        <div>${mensaje}</div>
      `;
      result.className = tipo;
      result.style.display = 'block';
      
      setTimeout(() => {
        result.style.display = 'none';
      }, 3000);
    }

    // Verificar si es hoy
    function esHoy(fechaStr) {
      const fechaRegistro = new Date(fechaStr);
      const hoy = new Date();
      return fechaRegistro.getDate() === hoy.getDate() && 
             fechaRegistro.getMonth() === hoy.getMonth() && 
             fechaRegistro.getFullYear() === hoy.getFullYear();
    }
  </script>
</body>
</html>
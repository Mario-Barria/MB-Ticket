<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escaneo de Entradas - MB Ticket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    button {
      margin: 5px;
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    .debug-box {
      background: #f0f0f0;
      font-family: monospace;
      padding: 10px;
      margin-top: 15px;
      white-space: pre-wrap;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Escaneo de Entradas - MB Ticket</h1>
    <button onclick="simularEscaneo()">Simular escaneo</button>
    <button onclick="registrarManual()">Registrar manual</button>
    <button onclick="borrarRegistros()">Borrar registros</button>

    <h2>Registros de Hoy</h2>
    <table id="tabla-registros">
      <thead>
        <tr><th>Nombre</th><th>DNI</th><th>Hora</th></tr>
      </thead>
      <tbody id="tbody-registros">
        <tr><td colspan="3">No hay registros aún.</td></tr>
      </tbody>
    </table>

    <h3>📦 Vista rápida de localStorage.registros</h3>
    <div class="debug-box" id="debugBox">Esperando registros...</div>
  </div>

  <script>
    let registros = [];

    function cargarRegistros() {
      registros = JSON.parse(localStorage.getItem('registros') || '[]');
    }

    function guardarRegistros() {
      localStorage.setItem('registros', JSON.stringify(registros));
    }

    function actualizarRegistros() {
      const hoy = new Date().toLocaleDateString();
      const tbody = document.getElementById('tbody-registros');
      tbody.innerHTML = '';
      const registrosHoy = registros.filter(r => new Date(r.fecha).toLocaleDateString() === hoy);
      if (registrosHoy.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No hay registros aún.</td></tr>';
        return;
      }
      registrosHoy.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.nombre}</td><td>${r.dni}</td><td>${r.fecha.split(',')[1]}</td>`;
        tbody.appendChild(tr);
      });
    }

    function simularEscaneo() {
      const nombre = "Test Usuario";
      const dni = "99999999";
      const fecha = new Date().toLocaleString();
      cargarRegistros();

      const hoy = new Date().toLocaleDateString();
      const yaExiste = registros.some(r => r.dni === dni && new Date(r.fecha).toLocaleDateString() === hoy);

      if (yaExiste) {
        alert("⚠️ Ya se registró este DNI hoy.");
        return;
      }

      registros.push({ nombre, dni, fecha, tipo: "debug" });
      guardarRegistros();
      actualizarRegistros();
      mostrarDebug();
    }

    function registrarManual() {
      const nombre = "Test Manual";
      const dni = "88888888";
      const fecha = new Date().toLocaleString();
      cargarRegistros();

      const hoy = new Date().toLocaleDateString();
      const yaExiste = registros.some(r => r.dni === dni && new Date(r.fecha).toLocaleDateString() === hoy);

      if (yaExiste) {
        alert("⚠️ Ya se registró este DNI hoy.");
        return;
      }

      registros.push({ nombre, dni, fecha, tipo: "manual" });
      guardarRegistros();
      actualizarRegistros();
      mostrarDebug();
    }

    function borrarRegistros() {
      if (confirm("¿Estás seguro de borrar todos los registros?")) {
        localStorage.removeItem('registros');
        registros = [];
        actualizarRegistros();
        mostrarDebug();
      }
    }

    function mostrarDebug() {
      document.getElementById('debugBox').textContent = JSON.stringify(registros, null, 2);
    }

    // Cargar al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      cargarRegistros();
      actualizarRegistros();
      mostrarDebug();
    });
  </script>
</body>
</html>

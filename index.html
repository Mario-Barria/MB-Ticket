<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validador de Socios MB-Ticket</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #2980b9; /* Azul más oscuro */
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #2ecc71; /* Verde en lugar de naranja */
      --light: #ecf0f1;
      --dark: #2c3e50;
      --accent: #9b59b6;
    }
    
    /* [Mantén los estilos base anteriores...] */

    /* Botones mejorados */
    button {
      padding: 15px 25px;
      color: white !important; /* Texto blanco forzado */
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px auto;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s;
      width: 100%;
      max-width: 300px;
      display: block;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    #exportBtn {
      background: linear-gradient(to right, var(--secondary), #3498db);
    }

    #clearBtn {
      background: linear-gradient(to right, var(--danger), #c0392b);
      margin-top: 20px; /* Más espacio */
    }

    #manualRegisterBtn {
      background: linear-gradient(to right, var(--warning), #27ae60);
    }

    /* Mejoras visuales para la carga de archivos */
    #csvFile {
      display: none;
    }

    .file-upload label {
      background: var(--secondary);
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload label:hover {
      background: #3498db;
      transform: translateY(-2px);
    }

    #csvStatus {
      margin-top: 10px;
      font-weight: bold;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <!-- [Mantén la misma estructura HTML anterior...] -->

  <script>
    // Variables globales (asegúrate de tener estas)
    let socios = [];
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let scanner;
    let scanning = false;

    // Función CORREGIDA para cargar CSV
    function cargarCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
          
          socios = lines.map(line => {
            const parts = line.split(';');
            // Asegura que haya al menos 3 columnas (nombre, apellido, dni)
            if (parts.length < 3) {
              throw new Error("Formato de CSV incorrecto");
            }
            return {
              dni: parts[2].trim(),
              nombre: `${parts[0].trim()} ${parts[1].trim()}`
            };
          });

          csvStatus.textContent = `✅ Archivo cargado: ${socios.length} socios`;
          csvStatus.style.color = "green";
          exportBtn.disabled = false;
          iniciarEscaneo();

        } catch (error) {
          csvStatus.textContent = `❌ Error: El archivo debe tener formato: Nombre;Apellido;DNI`;
          csvStatus.style.color = "red";
          console.error("Error al procesar CSV:", error);
        }
      };
      
      reader.onerror = () => {
        csvStatus.textContent = "❌ Error al leer el archivo";
        csvStatus.style.color = "red";
      };
      
      reader.readAsText(file, "UTF-8");
    }

    // [Mantén las demás funciones igual pero asegúrate de tener:]
    function iniciarEscaneo() {
      if (scanning || socios.length === 0) return;

      if (scanner) {
        scanner.stop().catch(() => {});
      }

      scanner = new Html5Qrcode("reader");
      const config = {
        fps: 10,
        qrbox: 250,
        disableFlip: true
      };

      scanner.start(
        { facingMode: "environment" },
        config,
        (qrCodeMessage) => {
          scanner.pause();
          procesarQR(qrCodeMessage);
          setTimeout(() => scanner.resume().catch(() => iniciarEscaneo()), 2000);
        },
        (error) => console.log("Error de escaneo:", error)
      ).then(() => {
        scanning = true;
      }).catch(err => {
        console.error("Error al iniciar cámara:", err);
      });
    }

    // [Las demás funciones permanecen iguales...]
  </script>
</body>
</html>
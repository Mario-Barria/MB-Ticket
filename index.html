<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Esta l√≠nea debe ir primero o casi primero en el head -->
    <link rel="manifest" href="manifest.json">
    
    <meta charset="UTF-8">
    <title>Mi App</title>
    ...
</head>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Acceso - Estadio</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #2980b9;
      --success: #27ae60;
      --danger: #e74c3c;
      --info: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: var(--dark);
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo {
      height: 80px;
      margin-bottom: 10px;
    }
    
    .panel {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .panel-title {
      margin-top: 0;
      color: var(--primary);
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .file-upload {
      margin-bottom: 15px;
    }
    
    .file-upload label {
      display: inline-block;
      background: var(--secondary);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    
    .file-upload input {
      display: none;
    }
    
    .file-status {
      margin-top: 10px;
      font-weight: bold;
    }
    
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #result {
      display: none;
      margin: 20px auto;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 500px;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    button {
      padding: 12px 20px;
      color: white !important;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px auto;
      font-weight: bold;
      width: 100%;
      max-width: 300px;
      display: block;
      transition: all 0.3s;
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    #exportBtn {
      background: var(--secondary);
    }
    
    #clearBtn {
      background: var(--danger);
    }
    
    #manualRegisterBtn {
      background: var(--success);
    }
    
    #importWebBtn {
      background: var(--info);
    }
    
    .search-box {
      margin-bottom: 15px;
    }
    
    .search-results {
      position: relative;
    }
    
    #searchInput {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    #resultsList {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    
    .result-item:hover {
      background-color: #f5f5f5;
    }
    
    .result-item strong {
      color: var(--secondary);
    }
    
    #registros-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .registro-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .registro-item:last-child {
      border-bottom: none;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    
    .tab.active {
      background: var(--secondary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .panel {
        padding: 10px;
      }
      
      button {
        padding: 10px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
  <img src="Logo MB-ticket.png" alt="Logo" class="logo">
  <h1>Control de Acceso - Estadio</h1>
</header>
    <div class="tabs">
      <div class="tab active" data-tab="ingreso">Registro de Ingresos</div>
      <div class="tab" data-tab="importar">Importar Entradas Web</div>
    </div>

    <!-- Pesta√±a de Ingreso -->
    <div id="ingreso" class="tab-content active">
      <div class="panel">
        <h3 class="panel-title">Carga de Socios</h3>
        <div class="file-upload">
          <label for="csvFile">Seleccionar listado de socios (CSV)</label>
          <input type="file" id="csvFile" accept=".csv">
          <p id="csvStatus" class="file-status">Esperando archivo CSV...</p>
        </div>
      </div>

      <div class="panel">
        <h3 class="panel-title">B√∫squeda Manual</h3>
        <div class="search-box">
          <div class="search-results">
            <input type="text" id="searchInput" placeholder="Buscar por DNI o nombre (m√≠nimo 3 caracteres)">
            <div id="resultsList"></div>
          </div>
          <button id="manualRegisterBtn" disabled>Registrar Ingreso Manual</button>
        </div>
      </div>

      <div class="panel">
        <h3 class="panel-title">Escaneo de Carnets</h3>
        <div id="reader"></div>
        <div id="result">
          <div id="icon" class="icon"></div>
          <div id="message"></div>
        </div>
      </div>
    </div>

    <!-- Pesta√±a de Importaci√≥n -->
    <div id="importar" class="tab-content">
      <div class="panel">
        <h3 class="panel-title">Importar Entradas Web</h3>
        <div class="file-upload">
          <label for="webSalesFile">Seleccionar archivo de ventas web (Excel/CSV)</label>
          <input type="file" id="webSalesFile" accept=".csv,.xlsx,.xls">
          <p id="webSalesStatus" class="file-status">Esperando archivo de ventas web...</p>
        </div>
        <button id="importWebBtn" disabled>Importar Entradas</button>
        <p id="importSummary" style="margin-top: 15px;"></p>
      </div>
    </div>

    <div class="panel">
      <h3 class="panel-title">Registros de Hoy</h3>
      <div id="registros-list">
        <p>No hay registros a√∫n.</p>
      </div>
      <button id="exportBtn">Generar Informe</button>
      <button id="clearBtn">Limpiar Registros</button>
    </div>
  </div>

  <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
  <audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

  <!-- Biblioteca para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Variables globales
    let socios = [];
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let entradasWeb = JSON.parse(localStorage.getItem('entradasWeb')) || [];
    let scanner;
    let selectedSocio = null;
    let ultimoEscaneo = null;

    // Elementos del DOM
    const csvFile = document.getElementById('csvFile');
    const csvStatus = document.getElementById('csvStatus');
    const webSalesFile = document.getElementById('webSalesFile');
    const webSalesStatus = document.getElementById('webSalesStatus');
    const importWebBtn = document.getElementById('importWebBtn');
    const importSummary = document.getElementById('importSummary');
    const searchInput = document.getElementById('searchInput');
    const resultsList = document.getElementById('resultsList');
    const manualRegisterBtn = document.getElementById('manualRegisterBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const registrosList = document.getElementById('registros-list');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Eventos
    csvFile.addEventListener('change', cargarSociosCSV);
    webSalesFile.addEventListener('change', cargarEntradasWeb);
    importWebBtn.addEventListener('click', importarEntradasWeb);
    searchInput.addEventListener('input', buscarSocios);
    manualRegisterBtn.addEventListener('click', registrarManual);
    exportBtn.addEventListener('click', exportarRegistros);
    clearBtn.addEventListener('click', limpiarRegistros);

    // Tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Cargar socios desde CSV
    // Cargar socios desde CSV (versi√≥n original que funcionaba)
function cargarSociosCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      // Eliminar BOM si existe (para compatibilidad con Excel)
      const contentWithoutBOM = content.replace(/^\uFEFF/, '');
      const lines = contentWithoutBOM.split(/\r?\n/).filter(line => line.trim() !== '');
      
      socios = lines.map(line => {
        // Manejar CSV con punto y coma o coma
        const separator = line.includes(';') ? ';' : ',';
        const [nombre, apellido, dni] = line.split(separator);
        return {
          nombre: `${nombre.trim()} ${apellido.trim()}`,
          dni: dni.trim()
        };
      });

      csvStatus.textContent = `‚úÖ Socios cargados: ${socios.length}`;
      csvStatus.style.color = "green";
      exportBtn.disabled = false;
      iniciarEscaneo();

      // Debug: mostrar primeros socios en consola
      console.log("Socios cargados:", socios.slice(0, 5));

    } catch (error) {
      csvStatus.textContent = "‚ùå Error: El archivo debe tener formato: Nombre,Apellido,DNI o Nombre;Apellido;DNI";
      csvStatus.style.color = "red";
      console.error("Error al procesar CSV:", error);
    }
  };
  
  reader.onerror = () => {
    csvStatus.textContent = "‚ùå Error al leer el archivo";
    csvStatus.style.color = "red";
  };
  
  reader.readAsText(file, 'UTF-8');
}
    // Cargar entradas web desde Excel/CSV
    function cargarEntradasWeb(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          // Suponemos que el Excel tiene columna "DNI"
          const dnis = jsonData.map(item => item.DNI?.toString().trim()).filter(Boolean);
          
          webSalesStatus.textContent = `‚úÖ Entradas web cargadas: ${dnis.length}`;
          webSalesStatus.style.color = "green";
          importWebBtn.disabled = false;
          
          // Guardar temporalmente para importaci√≥n
          entradasWeb = dnis;

        } catch (error) {
          webSalesStatus.textContent = "‚ùå Error: El archivo debe tener columna 'DNI'";
          webSalesStatus.style.color = "red";
          console.error("Error al procesar archivo:", error);
        }
      };
      
      reader.onerror = () => {
        webSalesStatus.textContent = "‚ùå Error al leer el archivo";
        webSalesStatus.style.color = "red";
      };
      
      reader.readAsArrayBuffer(file);
    }

    // Importar entradas web al sistema
    function importarEntradasWeb() {
      if (entradasWeb.length === 0) {
        mostrarResultado('error', '‚ùå Error', 'No hay entradas web para importar');
        return;
      }

      const hoy = new Date().toLocaleDateString();
      let nuevosRegistros = 0;
      let duplicados = 0;

      entradasWeb.forEach(dni => {
        // Verificar si ya est√° registrado hoy
        const yaRegistrado = registros.some(r => 
          r.dni === dni && 
          new Date(r.fecha).toLocaleDateString() === hoy
        );

        if (!yaRegistrado) {
          registros.push({
            dni: dni,
            nombre: "Entrada Web",
            fecha: new Date().toLocaleString(),
            tipo: "web"
          });
          nuevosRegistros++;
        } else {
          duplicados++;
        }
      });

      localStorage.setItem('registros', JSON.stringify(registros));
      actualizarRegistros();
      
      importSummary.innerHTML = `
        <strong>Resumen de importaci√≥n:</strong><br>
        ‚úÖ Nuevos registros: ${nuevosRegistros}<br>
        ‚ö†Ô∏è Duplicados: ${duplicados}<br>
        üìÖ Total registros hoy: ${registros.filter(r => esHoy(r.fecha)).length}
      `;
      
      mostrarResultado('success', '‚úÖ Importaci√≥n completada', `
        Se importaron ${nuevosRegistros} entradas web<br>
        ${duplicados} ya estaban registradas
      `);
    }

    // Buscar socios (autocompletado)
    function buscarSocios() {
      const query = searchInput.value.trim().toLowerCase();
      resultsList.innerHTML = '';
      selectedSocio = null;
      manualRegisterBtn.disabled = true;

      if (query.length < 3) {
        resultsList.style.display = 'none';
        return;
      }

      const resultados = socios.filter(socio => 
        socio.dni.includes(query) || 
        socio.nombre.toLowerCase().includes(query)
      );

      if (resultados.length > 0) {
        resultsList.innerHTML = resultados.map(socio => `
          <div class="result-item" data-dni="${socio.dni}">
            <strong>${socio.nombre}</strong><br>
            DNI: ${socio.dni}
          </div>
        `).join('');
        resultsList.style.display = 'block';
        
        document.querySelectorAll('.result-item').forEach(item => {
          item.addEventListener('click', function() {
            const dni = this.getAttribute('data-dni');
            selectedSocio = socios.find(s => s.dni === dni);
            searchInput.value = selectedSocio.nombre;
            resultsList.style.display = 'none';
            manualRegisterBtn.disabled = false;
          });
        });
      } else {
        resultsList.innerHTML = '<div class="result-item">No se encontraron socios</div>';
        resultsList.style.display = 'block';
      }
    }

    // Iniciar esc√°ner
    // REEMPLAZAR FUNCI√ìN iniciarEscaneo()
function iniciarEscaneo() {
  if (window.scanner && window.scanner.isScanning) return;
  
  window.scanner = new Html5Qrcode("reader");
  window.scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      procesarQR(decodedText);
    },
    (error) => {
      // Ignorar errores comunes (sin detener esc√°ner)
      if (error !== "NotFoundException") {
        console.log("Error esc√°ner:", error);
      }
    }
  ).then(() => {
    console.log("Esc√°ner activo");
  }).catch(err => {
    console.error("Error al iniciar:", err);
  });
}

    // Procesar QR
    // REEMPLAZAR FUNCI√ìN procesarQR()
function procesarQR(qrContent) {
  // Usar temporizador para permitir re-escaneo despu√©s de 1.5 segundos
  const ahora = Date.now();
  if (window.ultimoEscaneo && (ahora - window.ultimoEscaneo < 1500)) return;
  window.ultimoEscaneo = ahora;

  const dni = qrContent.split('=')[1] || qrContent;
  const socio = socios.find(s => s.dni === dni.trim());
  
  if (!socio) {
    mostrarResultado('error', '‚ùå No registrado', `DNI: ${dni}`);
    document.getElementById('errorSound').play();
    return;
  }

  const hoy = new Date().toLocaleDateString();
  const yaRegistrado = registros.some(r => 
    r.dni === socio.dni && 
    new Date(r.fecha).toLocaleDateString() === hoy
  );

  if (yaRegistrado) {
    mostrarResultado('error', '‚ùå Ya ingres√≥ hoy', `
      ${socio.nombre}<br>
      DNI: ${socio.dni}
    `);
    document.getElementById('errorSound').play();
    return;
  }

  // Registrar el ingreso
  registros.push({
    dni: socio.dni,
    nombre: socio.nombre,
    fecha: new Date().toLocaleString(),
    tipo: "carnet"
  });
  
  localStorage.setItem('registros', JSON.stringify(registros));
  actualizarRegistros();
  
  mostrarResultado('success', '‚úÖ Registrado', `
    ${socio.nombre}<br>
    DNI: ${socio.dni}
  `);
  document.getElementById('successSound').play();
}

    // Registrar manualmente
    function registrarManual() {
      if (!selectedSocio) {
        mostrarResultado('error', '‚ùå Error', 'Seleccione un socio de la lista');
        document.getElementById('errorSound').play();
        return;
      }

      const hoy = new Date().toLocaleDateString();
      const registroExistente = registros.find(r => 
        r.dni === selectedSocio.dni && 
        new Date(r.fecha).toLocaleDateString() === hoy
      );

      if (registroExistente) {
        mostrarResultado('error', '‚ùå Ya ingres√≥ hoy', `
          ${selectedSocio.nombre}<br>
          DNI: ${selectedSocio.dni}<br>
          Hora: ${registroExistente.fecha.split(',')[1].trim()}
        `);
        document.getElementById('errorSound').play();
        return;
      }

      const registro = {
        dni: selectedSocio.dni,
        nombre: selectedSocio.nombre,
        fecha: new Date().toLocaleString(),
        tipo: "manual"
      };
      
      registros.push(registro);
      localStorage.setItem('registros', JSON.stringify(registros));
      actualizarRegistros();
      
      mostrarResultado('success', '‚úÖ Registrado', selectedSocio.nombre);
      document.getElementById('successSound').play();
      
      // Limpiar b√∫squeda
      searchInput.value = '';
      resultsList.style.display = 'none';
      selectedSocio = null;
      manualRegisterBtn.disabled = true;
    }

    // Actualizar registros
    function actualizarRegistros() {
  // M√©todo ultra-compatible para m√≥viles
  const hoy = new Date().toLocaleDateString();
  const registrosGuardados = localStorage.getItem('registros');
  const registros = registrosGuardados ? JSON.parse(registrosGuardados) : [];
  
  const registrosHoy = registros.filter(r => 
    new Date(r.fecha).toLocaleDateString() === hoy
  );

  // Limpiar y reconstruir manualmente
  const lista = document.getElementById('registros-list');
  lista.innerHTML = ''; // Limpiar primero
  
  if (registrosHoy.length === 0) {
    lista.innerHTML = '<p>No hay registros a√∫n.</p>';
    return;
  }

  // Crear elementos DOM manualmente
  registrosHoy.forEach(r => {
    const item = document.createElement('div');
    item.className = 'registro-item';
    item.innerHTML = `
      <strong>${r.fecha}</strong><br>
      ${r.nombre} (DNI: ${r.dni})<br>
      <small>Tipo: ${r.tipo === 'web' ? 'Entrada Web' : r.tipo === 'manual' ? 'Registro Manual' : 'Carnet'}</small>
    `;
    lista.appendChild(item);
  });
}
    // Exportar registros
    function exportarRegistros() {
      const hoy = new Date().toLocaleDateString();
      const registrosHoy = registros.filter(r => 
        new Date(r.fecha).toLocaleDateString() === hoy
      );

      let csv = "Fecha,Nombre,DNI,Tipo\n";
      registrosHoy.forEach(r => {
        csv += `"${r.fecha}","${r.nombre}","${r.dni}","${r.tipo}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `registros_${hoy.replace(/\//g, '-')}.csv`;
      a.click();
    }

    // Limpiar registros
    function limpiarRegistros() {
      if (confirm('¬øBorrar todos los registros de hoy?')) {
        const hoy = new Date().toLocaleDateString();
        registros = registros.filter(r => 
          new Date(r.fecha).toLocaleDateString() !== hoy
        );
        localStorage.setItem('registros', JSON.stringify(registros));
        actualizarRegistros();
      }
    }

    // Mostrar resultado
    function mostrarResultado(tipo, icono, mensaje) {
  const result = document.getElementById('result');
  result.innerHTML = `
    <div class="icon">${icono}</div>
    <div>${mensaje}</div>
  `;
  result.className = tipo;
  result.style.display = 'block';

  // Reproducir sonido directamente (sin activaci√≥n previa)
  try {
    const sound = tipo === 'success' ? 
      document.getElementById('successSound') : 
      document.getElementById('errorSound');
    sound.currentTime = 0;
    sound.play().catch(e => console.log("Navegador bloque√≥ sonido autom√°tico:", e));
  } catch (e) {
    console.log("Error en sonido:", e);
  }

  setTimeout(() => {
    result.style.display = 'none';
  }, 3000);
}
    // Verificar si es hoy
    function esHoy(fechaStr) {
      const fechaRegistro = new Date(fechaStr);
      const hoy = new Date();
      return fechaRegistro.getDate() === hoy.getDate() && 
             fechaRegistro.getMonth() === hoy.getMonth() && 
             fechaRegistro.getFullYear() === hoy.getFullYear();
    }
/ ===== SISTEMA DE ACTUALIZACI√ìN PARA M√ìVILES ===== //
// 1. Actualizar cada 2 segundos (solo en m√≥vil)
if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
  setInterval(actualizarRegistros, 2000);
  
  // 2. Actualizar al hacer clic en cualquier parte
  document.addEventListener('click', actualizarRegistros);
  
  // 3. Guardar autom√°ticamente
  const originalPush = Array.prototype.push;
  Array.prototype.push = function() {
    const result = originalPush.apply(this, arguments);
    localStorage.setItem('registros', JSON.stringify(registros));
    setTimeout(actualizarRegistros, 500); // Actualizar con retraso
    return result;
  };
}

// Actualizar al cargar
document.addEventListener('DOMContentLoaded', actualizarRegistros);


  </script>
</body>
</html>
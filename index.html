<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Acceso - Estadio</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <style>
        /* [Todo el CSS anterior se mantiene igual] */
        /* ... (pegar aquí todo el CSS de la versión anterior) ... */
    </style>
</head>
<body>
    <!-- [Todo el HTML anterior se mantiene igual] -->
    <!-- ... (pegar aquí todo el HTML de la versión anterior) ... -->

    <script>
        // Variables globales
        let socios = [];
        let registros = JSON.parse(localStorage.getItem('registros')) || [];
        let entradasWeb = JSON.parse(localStorage.getItem('entradasWeb')) || [];
        let scanner;
        let selectedSocio = null;
        let ultimoEscaneo = null;
        let escaneoActivo = false;

        // [Resto de declaraciones de elementos DOM y eventos se mantienen igual]
        // ... (pegar aquí las declaraciones de la versión anterior) ...

        // Iniciar escáner (FUNCIÓN MODIFICADA)
        function iniciarEscaneo() {
            if (scanner || escaneoActivo) return;
            
            escaneoActivo = true;
            const config = { fps: 10, qrbox: 250 };
            
            Html5Qrcode.getCameras().then(devices => {
                const cameraId = devices.length > 1 ? 
                    devices.find(d => d.label.includes("back"))?.id || 
                    devices[0].id : 
                    devices[0]?.id;
                
                scanner = new Html5Qrcode("reader");
                scanner.start(
                    cameraId || { facingMode: "environment" }, 
                    config,
                    qrCodeMessage => {
                        procesarQR(qrCodeMessage);
                        setTimeout(reiniciarEscaneo, 1000);
                    },
                    errorMessage => {
                        console.log("Error:", errorMessage);
                        reiniciarEscaneo();
                    }
                ).catch(err => {
                    console.error("Error al iniciar escáner:", err);
                    reiniciarEscaneo();
                });
            }).catch(err => {
                console.error("Error al obtener cámaras:", err);
                reiniciarEscaneo();
            });
        }

        // Nueva función para reiniciar escáner
        function reiniciarEscaneo() {
            if (scanner) {
                scanner.stop().then(() => {
                    scanner = null;
                    escaneoActivo = false;
                    if (socios.length > 0) {
                        iniciarEscaneo();
                    }
                }).catch(err => {
                    console.error("Error al detener escáner:", err);
                    scanner = null;
                    escaneoActivo = false;
                });
            } else {
                escaneoActivo = false;
            }
        }

        // Procesar QR (FUNCIÓN MODIFICADA)
        function procesarQR(qrContent) {
            if (escaneoActivo === false) return;
            
            // Extraer DNI del QR (mejorado para varios formatos)
            let dni = qrContent;
            const dniMatch = qrContent.match(/(?:DNI|dni)[:=]?\s*(\d+)/i);
            if (dniMatch && dniMatch[1]) {
                dni = dniMatch[1];
            } else if (qrContent.includes('=')) {
                dni = qrContent.split('=')[1];
            }

            dni = dni.trim();
            const socio = socios.find(s => s.dni === dni);
            
            if (!socio) {
                mostrarResultado('error', '❌ No registrado', `DNI: ${dni}`);
                playSound('errorSound');
                return;
            }

            // Verificar registro existente (mejorado)
            const ahora = new Date();
            const hoy = ahora.toISOString().split('T')[0];
            const registroExistente = registros.find(r => {
                try {
                    const fechaReg = new Date(r.fecha);
                    const fechaRegNormalizada = fechaReg.toISOString().split('T')[0];
                    return r.dni === dni && fechaRegNormalizada === hoy;
                } catch {
                    return false;
                }
            });

            if (registroExistente) {
                mostrarResultado('error', '❌ Ya ingresó hoy', `
                    ${socio.nombre}<br>
                    DNI: ${dni}<br>
                    Hora: ${registroExistente.fecha.split(',')[1]?.trim() || ''}
                `);
                playSound('errorSound');
                return;
            }

            // Registrar nuevo ingreso
            const registro = {
                dni: dni,
                nombre: socio.nombre,
                fecha: ahora.toLocaleString(),
                tipo: "carnet"
            };
            
            registros.push(registro);
            guardarRegistros();
            actualizarRegistros();
            
            mostrarResultado('success', '✅ Registrado', `
                ${socio.nombre}<br>
                DNI: ${dni}
            `);
            playSound('successSound');
        }

        // Nueva función para reproducir sonidos
        function playSound(id) {
            try {
                const sound = document.getElementById(id);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log("Error al reproducir sonido:", e));
                }
            } catch (e) {
                console.log("Error con sonido:", e);
            }
        }

        // Función para guardar registros (mejorada)
        function guardarRegistros() {
            try {
                localStorage.setItem('registros', JSON.stringify(registros));
            } catch (e) {
                console.error("Error al guardar registros:", e);
                // Intentar con menos datos si hay error de almacenamiento
                if (e.name === 'QuotaExceededError') {
                    localStorage.setItem('registros', JSON.stringify(registros.slice(-100)));
                    mostrarResultado('info', '⚠️ Advertencia', 'Se conservaron solo los últimos 100 registros');
                }
            }
        }

        // Actualizar registros (FUNCIÓN MEJORADA)
        function actualizarRegistros() {
            try {
                const hoy = new Date().toISOString().split('T')[0];
                const registrosHoy = registros.filter(r => {
                    try {
                        const fechaReg = new Date(r.fecha);
                        const fechaRegNormalizada = fechaReg.toISOString().split('T')[0];
                        return fechaRegNormalizada === hoy;
                    } catch {
                        return false;
                    }
                });

                registrosList.innerHTML = registrosHoy.length > 0
                    ? registrosHoy.map(r => `
                        <div class="registro-item">
                            <strong>${r.fecha}</strong><br>
                            ${r.nombre || 'Nombre no disponible'} (DNI: ${r.dni || 'N/A'})<br>
                            <small>Tipo: ${ 
                                r.tipo === 'web' ? 'Entrada Web' : 
                                r.tipo === 'manual' ? 'Registro Manual' : 
                                'Carnet'
                            }</small>
                        </div>
                    `).join('')
                    : '<p>No hay registros aún.</p>';
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                registrosList.innerHTML = '<p class="error">Error al cargar registros</p>';
            }
        }

        // [Resto de funciones se mantienen igual pero usando guardarRegistros() en lugar de localStorage.setItem directamente]
        // ... (pegar aquí el resto de funciones de la versión anterior, reemplazando localStorage.setItem por guardarRegistros()) ...
    </script>
</body>
</html>
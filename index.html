
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Escaneo de Entradas - MB Ticket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #preview { width: 100%; height: auto; border: 1px solid #ccc; }
        #registros { margin-top: 20px; }
        .registro-item { padding: 5px; border-bottom: 1px solid #eee; }
        button { margin: 10px 5px 0 0; padding: 10px 15px; }
    </style>
</head>
<body>
    <h2>Escaneo de Entradas - MB Ticket</h2>
    <video id="preview"></video>

    <div>
        <button onclick="cambiarCamara()">Cambiar Cámara</button>
        <button onclick="generarInforme()">Generar Informe</button>
        <button onclick="borrarRegistros()">Borrar Registros</button>
    </div>

    <div id="mensaje" style="margin-top:10px;"></div>

    <h3>Registros de Hoy</h3>
    <div id="registros"></div>

    <p style="font-size: 0.8em; color: gray;">Versión 1.2 - 21/05/2025</p>

    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script>
        let registros = JSON.parse(localStorage.getItem('registros') || '[]');
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });
        let camaraActual = 0;
        let cams = [];

        scanner.addListener('scan', function (content) {
            registrarEntrada(content);
        });

        Instascan.Camera.getCameras().then(function (cameras) {
            cams = cameras;
            if (cams.length > 0) {
                scanner.start(cams[camaraActual]);
            } else {
                alert('No se encontraron cámaras.');
            }
        }).catch(function (e) {
            console.error(e);
        });

        function cambiarCamara() {
            camaraActual = (camaraActual + 1) % cams.length;
            scanner.start(cams[camaraActual]);
        }

        function registrarEntrada(codigo) {
            if (codigo && !registros.some(r => r.codigo === codigo)) {
                const registro = {
                    codigo,
                    hora: new Date().toLocaleTimeString()
                };
                registros.push(registro);
                guardarRegistros();
                actualizarListaRegistros();
                mostrarMensaje('✅ Registrado: ' + codigo, true);
            } else {
                mostrarMensaje('⚠️ Este código ya fue escaneado.', false);
            }
        }

        function guardarRegistros() {
            localStorage.setItem('registros', JSON.stringify(registros));
        }

        function actualizarListaRegistros() {
            const contenedor = document.getElementById('registros');
            contenedor.innerHTML = '';
            registros.forEach(r => {
                const div = document.createElement('div');
                div.className = 'registro-item';
                div.textContent = `${r.codigo} - ${r.hora}`;
                contenedor.appendChild(div);
            });
        }

        function generarInforme() {
            if (registros.length === 0) {
                alert('No hay registros para exportar.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,Código,Hora\n";
            registros.forEach(r => {
                csvContent += `${r.codigo},${r.hora}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "registros.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function borrarRegistros() {
            if (confirm("¿Estás seguro de que querés borrar todos los registros?")) {
                registros = [];
                guardarRegistros();
                actualizarListaRegistros();
                mostrarMensaje("Registros borrados.", true);
            }
        }

        function mostrarMensaje(texto, exito) {
            const mensaje = document.getElementById('mensaje');
            mensaje.textContent = texto;
            mensaje.style.color = exito ? 'green' : 'red';
            setTimeout(() => mensaje.textContent = '', 3000);
        }

        window.addEventListener('load', actualizarListaRegistros);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Acceso - Estadio</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Mantener el mismo CSS que tenías -->
  <style>
    /* ... (todo tu CSS existente) ... */
  </style>
</head>
<body>
  <!-- ... (todo tu HTML existente) ... -->

  <script>
    // Variables globales - Añadir bandera para controlar el escáner
    let socios = [];
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let entradasWeb = [];
    let scanner = null;
    let selectedSocio = null;
    let ultimoEscaneo = null;
    let escanerActivo = false;

    // ... (resto de tus variables DOM existentes) ...

    // Modificar la función iniciarEscaneo()
    function iniciarEscaneo() {
      if (escanerActivo) return;
      
      escanerActivo = true;
      scanner = new Html5Qrcode("reader");
      
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          procesarQR(decodedText);
        },
        (error) => {
          console.log("Error escáner:", error);
          // No detener el escáner ante errores
        }
      ).catch(err => {
        console.error("Error al iniciar escáner:", err);
        escanerActivo = false;
      });
    }

    // Modificar procesarQR() para no detener el escáner
    function procesarQR(qrContent) {
      if (ultimoEscaneo === qrContent) return;
      ultimoEscaneo = qrContent;

      try {
        const dni = extraerDNI(qrContent); // Nueva función para manejar diferentes formatos QR
        const socio = socios.find(s => s.dni === dni);
        
        if (!socio) {
          mostrarResultado('error', '❌ No registrado', `DNI: ${dni}`);
          document.getElementById('errorSound').play();
          return;
        }

        const registroExistente = yaRegistradoHoy(dni);
        
        if (registroExistente) {
          mostrarResultado('error', '❌ Ya ingresó hoy', `
            ${socio.nombre}<br>
            DNI: ${dni}<br>
            Hora: ${registroExistente.fecha.split(',')[1].trim()}
          `);
          document.getElementById('errorSound').play();
          return;
        }

        registrarIngreso(dni, socio.nombre, "carnet");
        mostrarResultado('success', '✅ Registrado', `${socio.nombre}<br>DNI: ${dni}`);
        document.getElementById('successSound').play();

      } catch (error) {
        console.error("Error procesando QR:", error);
        mostrarResultado('error', '❌ Error', 'Formato QR no válido');
      }
    }

    // Nuevas funciones auxiliares
    function extraerDNI(qrContent) {
      // Manejar diferentes formatos de QR
      if (qrContent.includes('=')) {
        return qrContent.split('=')[1].trim();
      }
      return qrContent.trim();
    }

    function yaRegistradoHoy(dni) {
      const hoy = new Date().toLocaleDateString();
      return registros.find(r => 
        r.dni === dni && 
        new Date(r.fecha).toLocaleDateString() === hoy
      );
    }

    function registrarIngreso(dni, nombre, tipo) {
      const nuevoRegistro = {
        dni: dni,
        nombre: nombre,
        fecha: new Date().toLocaleString(),
        tipo: tipo
      };
      
      registros.push(nuevoRegistro);
      localStorage.setItem('registros', JSON.stringify(registros));
      actualizarRegistros();
    }

    // Mejorar la función de importación de Excel
    function cargarEntradasWeb(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          // Buscar columna DNI (case insensitive)
          const columnas = Object.keys(jsonData[0] || {});
          const columnaDNI = columnas.find(col => col.toLowerCase().includes('dni'));
          
          if (!columnaDNI) {
            throw new Error("No se encontró columna DNI");
          }
          
          const dnis = jsonData
            .map(item => item[columnaDNI]?.toString().trim())
            .filter(dni => dni && !isNaN(dni) && dni.length >= 7); // Validar que sea un DNI válido
          
          webSalesStatus.textContent = `✅ Entradas web cargadas: ${dnis.length}`;
          webSalesStatus.style.color = "green";
          importWebBtn.disabled = false;
          entradasWeb = dnis;

        } catch (error) {
          webSalesStatus.textContent = "❌ Error: El archivo debe contener una columna 'DNI' con números válidos";
          webSalesStatus.style.color = "red";
          console.error("Error procesando archivo:", error);
          entradasWeb = [];
          importWebBtn.disabled = true;
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    // ... (resto de tus funciones existentes) ...

    // Al cargar la página, iniciar el escáner si hay socios cargados
    document.addEventListener('DOMContentLoaded', () => {
      if (socios.length > 0) {
        iniciarEscaneo();
      }
    });
  </script>
</body>
</html>